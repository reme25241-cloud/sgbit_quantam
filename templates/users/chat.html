{% extends "base.html" %}
{% load static %}
{% block title %}Chat with {{ receiver.get_full_name|default:receiver.username }}{% endblock %}

{% block content %}
<style>
  .chat-sticky-card{
    position: sticky;
    top: 12px;
    z-index: 2;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(2,6,23,.10);
    overflow: hidden;
    background: #fff;
    max-height: calc(100vh - 24px - 64px);
    display: flex;
    flex-direction: column;
  }

  .chat-card-header{
    background: #fff;
    border-bottom: 1px solid #e5e7eb;
    position: sticky; top: 0; z-index: 3;
    padding: .75rem 1rem;
  }

  .chat-card-body{
    flex: 1 1 auto;
    overflow-y: auto;
    background: #f8f9fa;
    padding: 12px;
  }

  .chat-card-footer{
    position: sticky; bottom: 0; z-index: 3;
    background: #fff;
    border-top: 1px solid #e5e7eb;
    padding: .75rem;
  }

  .bubble{
    max-width:72%;
    word-wrap:break-word;
    padding: 12px 14px;
    border-radius:14px;
    box-shadow:0 6px 16px rgba(0,0,0,.08);
  }
  .bubble.me{ background:#0d6efd; color:#fff; border-bottom-right-radius:4px; }
  .bubble.them{ background:#fff; color:#111; border-bottom-left-radius:4px; }

  .msg-meta{ font-size:.8rem; color:#9ca3af; margin-top:6px; }
  .bubble.me .msg-meta{ color:#e3e8ef; }

  details.meta-block{
    background:#ffffff;
    color:#111;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:8px 10px;
    margin-top:8px;
  }
  details.meta-block > summary{
    cursor:pointer;
    font-weight:600;
    color:#374151;
  }

  .composer textarea{ resize:none; }
</style>

<div class="card chat-sticky-card">

  <!-- HEADER -->
  <div class="chat-card-header d-flex align-items-center">
    <a href="{% url 'user_list' %}" class="btn btn-sm btn-outline-secondary me-2">
      <i class="fa-solid fa-arrow-left"></i>
    </a>
    <i class="fa-solid fa-user-circle fa-2x text-secondary me-2"></i>
    <div>
      <h6 class="mb-0">{{ receiver.get_full_name|default:receiver.username }}</h6>
      <small class="text-muted">Online</small>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="chat-card-body">
    {% if messages %}
      {% for m in messages %}
        <div class="d-flex mb-3 {% if m.from == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
          <div class="bubble {% if m.from == request.user %}me{% else %}them{% endif %}">

            <small class="fw-bold d-block mb-1">
              {% if m.from == request.user %}You{% else %}{{ m.from.get_full_name|default:m.from.username }}{% endif %}
            </small>

            {% if m.plaintext %}
              <div>{{ m.plaintext }}</div>
            {% endif %}

            {% if m.image %}
              <img src="{{ m.image.url }}" class="img-fluid rounded mt-2" style="max-width:240px;">
            {% endif %}

            {% if m.audio %}
              <audio controls class="mt-2 w-100">
                <source src="{{ m.audio.url }}">
              </audio>
            {% endif %}

            {% if m.video %}
              <video controls class="mt-2 rounded" style="max-width:260px;">
                <source src="{{ m.video.url }}">
              </video>
            {% endif %}

            <div class="msg-meta">
              {{ m.timestamp|date:"Y-m-d H:i" }} Â·
              {% if m.signature_valid is True %}
                Signature: Verified
              {% elif m.signature_valid is False %}
                <span class="text-warning">Signature: Invalid</span>
              {% else %}
                Signature: N/A
              {% endif %}
            </div>

            {% if m.meta %}
              <details class="meta-block">
                <summary>Encryption metadata</summary>
                <pre class="mt-2">{{ m.meta|safe }}</pre>
              </details>
            {% endif %}

            <br>

            {% if m.meta %}
              <div class="sec-overview">
                <div class="d-flex flex-wrap align-items-center gap-2 mb-1">
                  <span class="badge text-bg-secondary">Sym: {{ m.meta.sym_algo|default:"-" }}</span>
                  <span class="badge text-bg-secondary">PQ-KEM: {{ m.meta.pq_kem|yesno:"Yes,No" }}</span>
                  <span class="badge text-bg-secondary">PQ-Sign: {{ m.meta.pq_sign|yesno:"Yes,No" }}</span>
                </div>
                <div class="small">
                  <div><strong>SHA3-256:</strong> {{ m.meta.hash_hex|default:"-"|slice:":40" }}{% if m.meta.hash_hex %}...{% endif %}</div>
                  <div><strong>KEM ct:</strong> {{ m.meta.kem_ct|default:"-"|slice:":36" }}{% if m.meta.kem_ct %}...{% endif %}</div>
                </div>
                <div class="small mt-2">
                  <strong>Roles:</strong> Kyber (KEM) shares a session key; Dilithium/Ed25519 proves sender; AES-GCM/ChaCha20 encrypts; SHA3-256 guards integrity.
                  <br>
                  <strong>Hacker challenges:</strong> MLWE (PQ-KEM) is infeasible; brute-forcing 256-bit symmetric keys is impractical; signature forgery fails without the private key.
                </div>
              </div>
            {% endif %}

            {% if m.decrypt_error %}
              <div class="text-danger small mt-1">
                Decrypt error: {{ m.decrypt_error }}
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-muted">No messages yet.</div>
    {% endif %}
  </div>

  <!-- COMPOSER -->
  <div class="chat-card-footer">
    <form method="post" enctype="multipart/form-data"
          class="composer d-flex flex-wrap align-items-center gap-2">
      {% csrf_token %}

      <!-- Attachments -->
      <label class="btn btn-light mb-0">
        <i class="fa-solid fa-image"></i>
        <input type="file" name="image" class="d-none" accept="image/*">
      </label>

      <label class="btn btn-light mb-0">
        <i class="fa-solid fa-microphone"></i>
        <input type="file" name="audio" class="d-none" accept="audio/*">
      </label>

      <label class="btn btn-light mb-0">
        <i class="fa-solid fa-video"></i>
        <input type="file" name="video" class="d-none" accept="video/*">
      </label>

      <!-- Text -->
      <textarea name="text" rows="1"
        class="form-control rounded-pill flex-grow-1"
        placeholder="Type a secure message..."></textarea>

      <!-- Cipher -->
      <select name="sym_algo" class="form-select form-select-sm">
        <option value="AES">AES-GCM</option>
        <option value="CHACHA20">ChaCha20</option>
      </select>

      <button type="submit" class="btn btn-primary rounded-circle">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </form>

    <div class="small text-muted mt-2">
      Media files are stored securely. Text messages are end-to-end encrypted.
    </div>
  </div>
</div>
{% endblock %}
